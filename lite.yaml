log:
  level: info
data_providers:
  - tag: chinalist
    file: ./rules/china_domain_list.txt
    auto_reload: true
  - tag: cdncn
    file: ./rules/cdn_domain_list.txt
    auto_reload: true
  - tag: ecscn
    file: ./ecs_cn_domain.txt
    auto_reload: true
plugins:
  - tag: cache
    type: cache
    args:
      size: 102400
      redis: 'redis://127.0.0.1:6379/0'
      lazy_cache_ttl: 86400
      lazy_cache_reply_ttl: 30
      cache_everything: true
  - tag: query_is_cn_domain
    type: query_matcher
    args:
      domain:
        - 'provider:chinalist'
        - 'provider:cdncn'
        - 'provider:ecscn'
  - tag: query_is_ptr
    type: query_matcher
    args:
      qtype:
        - 12
  - tag: forward_alidns_doh
    type: fast_forward
    args:
      upstream:
        - addr: 'https://223.6.6.6/dns-query'
  - tag: forward_dnspod_doh
    type: fast_forward
    args:
      upstream:
        - addr: 'https://120.53.53.53/dns-query'
  - tag: forward_tencentcloud
    type: fast_forward
    args:
      upstream:
        - addr: 'udp://183.60.83.19'
        - addr: 'udp://183.60.82.98'
  - tag: forward_moedns
    type: forward
    args:
      upstream:
        - addr: 'https://hk-hkg.moedns.dev/dns-hk'
      bootstrap:
        - 223.6.6.6
      timeout: 2
  - tag: main_sequence
    type: sequence
    args:
      exec:
        - if: query_is_ptr
          exec:
            - _new_empty_response
            - _return
        - cache
        - if: query_is_cn_domain
          exec:
            - forward_tencentcloud
            - _return
        - forward_moedns
servers:
  - exec: main_sequence
    listeners:
      - protocol: udp
        addr: 127.0.0.1:5533
      - protocol: tcp
        addr: 127.0.0.1:5533
