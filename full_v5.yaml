log:
  level: info

plugins:
  - tag: tag_cache
    type: cache
    args:
      size: 10240
      lazy_cache_ttl: 259200
      dump_file: ./cache.dump
      dump_interval: 3600
  - tag: cn_domain
    type: domain_set
    args:
      files:
        - "/etc/mosdns/rules/china_domain_list.txt"
        - "/etc/mosdns/rules/cdn_domain_list.txt"
        - "/etc/mosdns/ecs_cn_domain.txt"
  - tag: forward_alidns
    type: forward
    args:
      upstreams:
        - tag: ali1
          addr: "https://223.5.5.5/dns-query"
        - tag: ali2
          addr: "https://223.6.6.6/dns-query"
  - tag: forward_google
    type: forward
    args:
      upstreams:
        - tag: tailscale_udp
          addr: "100.77.149.73:10053"
        - tag: tailscale_tcp
          addr: "tcp://100.77.149.73:10053"
          enable_pipeline: true
        - tag: clash_tcp
          addr: "tcp://127.0.0.1:6053"
          enable_pipeline: true
  - tag: main
    type: sequence
    args:
      - matches:
          - qtype 12 # PTR
          - qtype 65 # HTTPS
        exec: reject 0 # DNS-Rcode
      - exec: $tag_cache
      - exec: prefer_ipv4
      - matches: has_resp
        exec: accept 
      - matches: qname $cn_domain
        exec: $forward_alidns     
      - exec: $forward_google
  - type: udp_server
    args:
      entry: main
      listen: 127.0.0.1:5533
